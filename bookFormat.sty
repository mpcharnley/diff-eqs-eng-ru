%FIXME: for PRINT run for lulu or kdp, search for %PRINT  (also
%search diffyqs.tex)

\usepackage{ifpdf}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{color}

% Times
%\usepackage{txfonts}
% NewTX fonts are nicer, though slightly looser.  Using these we
% can get rid of the extra spaces e.g. {\vec{x}\,}', if going back
% to txfonts, these would need to be stuck back in.  One disadvantage
% is that newtx fonts seem to be changing from time to time leading
% to possible changes in pagination ...
%\usepackage[tighter,defaultsups]{newtxtext}
%\usepackage[vvarbb]{newtxmath}
%STIX
%\usepackage{stix}
%\usepackage{stix2}
%KP
%\usepackage{kpfonts}

%Palatino
%\usepackage{mathpazo}
%\usepackage[scaled]{helvet}
% \usepackage[theoremfont]{newpxtext}
% \usepackage[vvarbb]{newpxmath}
% \linespread{1.05}

% Utopia
%\usepackage{fourier}
%\usepackage[scaled]{helvet}

%\usepackage{fouriernc}


% San Serif fonts
%\renewcommand{\familydefault}{\sfdefault}


% \usepackage[T1]{fontenc}

\usepackage{perpage}

\usepackage{tasks}
\usepackage{footnote}
\makesavenoteenv{tasks}

\usepackage[shortlabels]{enumitem}

%\usepackage{graphics}
\usepackage{tcolorbox}

\tcbuselibrary{theorems}

% Remove page numbers on chapter opens
\usepackage{titlesec}
\assignpagestyle{\chapter}{empty}

\usepackage[headings]{fullpage}

% smaller margins top/bottom margins
\addtolength{\textheight}{0.8in}
\addtolength{\topmargin}{-0.3in}

\usepackage{url}
\usepackage{varioref}
\usepackage{makeidx}
\usepackage{hyperref} % do NOT set [ocgcolorlinks] here!

%If you have an older tex installation you might need
%to comment out the next line:
%PRINT (COMMENT OUT FOR PRINT)
\usepackage[ocgcolorlinks]{ocgx2} %run without for lulu/kdp - This colors the links throughout the entire file, instead of underlining them. 

\usepackage{hypcap}
\usepackage[font={small,it}]{caption}
\usepackage{tikz-cd}
\usepackage{units}
\usepackage{booktabs}
\usepackage{microtype}
\usepackage{cancel}

\usepackage{tikz}
\usetikzlibrary{matrix}

% This is my modified wrapfig that doesn't use intextsep
\usepackage{mywrapfig}
\usepackage{import}

% Footnotes should use symbols, not numbers.  Numbered footnotes are
% evil, not using footmisc as it conflicts with hyperref
%\usepackage[perpage,symbol*]{footmisc}

% The [2] would not use star
%\MakePerPage[2]{footnote}
\MakePerPage{footnote}
\renewcommand{\thefootnote}{\fnsymbol{footnote}}

% to avoid counter error on footnotes on first pass
\makeatletter
\gdef\@ctrerr{%
  \@latex@warning{Counter too large}}
\makeatother


%% Maybe pick a color later??
\definecolor{mypersianblue}{rgb}{0.11, 0.22, 0.73}

\definecolor{rutgersred}{RGB}{204,0,51}

\hypersetup{
    pdfborderstyle={/S/U/W 0.5},
    %PRINT do this (and comment out the above):
    %pdfborder={0 0 0},
    citecolor=rutgersred,
    filecolor=mypersianblue,
    linkcolor=rutgersred,
    urlcolor=mypersianblue,
    pdftitle={Ordinary Differential Equations: An Introduction with Modeling and MATLAB},
    pdfsubject={Differential Equations},
    pdfkeywords={differential equations, ODE, Fourier series, Laplace
transform},
    pdfauthor={Matthew Charnley}
}

%%%%%%%%%%%%%%%%%%%%%%%

% Set up our index
\makeindex

% Very simple indexing
\newcommand{\myindex}[1]{#1\index{#1}}

% Quotes
\newcommand{\myquote}[1]{``#1''}

% define this to be empty to kill notes
\newcommand{\sectionnotes}[1]{\noindent \emph{Note: #1} \medskip \par}

% Define this to be empty to not skip page before the sections to
% save some paper
\newcommand{\sectionnewpage}{\clearpage}
%\newcommand{\sectionnewpage}{}

% This is used throughout for less obtrusive references to EP.
% Make it blank to remove unnecessary references to EP.
\newcommand{\EPref}[1]{#1}
%\newcommand{\EPref}[1]{}

%references to BD
\newcommand{\BDref}[1]{#1}
% \newcommand{\BDref}[1]{}

% Don't include subsections
\setcounter{tocdepth}{1}

\theoremstyle{plain}
% \newtheorem{theorem}{Theorem}[section]
% \newtheorem{definition}{Definition}[section]

\newtheoremstyle{exercise}% name
  {}% Space above
  {}% Space below
  %{\itshape}% Body font
  {\slshape}% Body font
  {}% Indent amount 1
  %{\bfseries \itshape}% Theorem head font
  {\bfseries \slshape}% Theorem head font
  {:}% Punctuation after theorem head
  {.5em}% Space after theorem head 2
  {}% Theorem head spec (can be left empty, meaning "normal")


\theoremstyle{exercise}
\newtheorem{exercise}{Exercise}[section]

\newtheoremstyle{definition}% name
  {}% Space above
  {}% Space below
  %{\itshape}% Body font
  {}% Body font
  {}% Indent amount 1
  %{\bfseries \itshape}% Theorem head font
  {\bfseries \slshape}% Theorem head font
  {:}% Punctuation after theorem head
  {.5em}% Space after theorem head 2
  {}% Theorem head spec (can be left empty, meaning "normal")


\theoremstyle{definition}
% \newtheorem{definition}{Definition}[section]


\newcommand{\ansMark}{\hspace{-0.5em}\textbf{*}\hspace{0.5em}}
% \newcommand{\noAnsMark}{\hspace{-0.5em}\textbf{:}\hspace{0.5em}}

% Answers
\newbox\answerscollect

\newcommand{\theanswer}{\textbf{\theexercise:}}

\newcommand{\exsol}[1]{\setbox\answerscollect=\vbox{\unvbox\answerscollect\medskip\par\noindent\theanswer\quad #1\par}}
\def\printanswers{
 \cleardoublepage  
 \phantomsection
 \chapter*{Answers to Selected Exercises}
 \markboth{ANSWERS TO SELECTED EXERCISES}{ANSWERS TO SELECTED EXERCISES}
 \addfakecontentsline{Answers to Selected Exercises}
 \unvbox\answerscollect\setbox\answerscollect=\vbox{}
}

%\newtheoremstyle{example}% name
%  {}% Space above
%  {}% Space below
%  {}% Body font
%  {}% Indent amount 1
%  {\bfseries}% Theorem head font
%  {:}% Punctuation after theorem head
%  {.5em}% Space after theorem head 2
%  {}% Theorem head spec (can be left empty, meaning "normal")
%
%\theoremstyle{example}
%\newtheorem{example}{Example}[section]
%\newtheorem{remark}{Remark}[section]
%

%%
%% Hand made example and remark so that it works with floating figure
%%
\newcounter{example}[section]
\renewcommand{\theexample}{\thesection.\arabic{example}}
\def\exampleclaim{\par\addvspace{\medskipamount}\noindent\refstepcounter{example}\hbox{\bf
Example
\thesection.\arabic{example}:}\hspace{0.5em}\ignorespaces}
\def\exampleclaimname#1{\par\addvspace{\medskipamount}\noindent\refstepcounter{example}\hbox{\bf
Example
\thesection.\arabic{example} {\rm (#1)}:}\hspace{0.5em}\ignorespaces}
\def\endexampleclaim{
\par\addvspace{\medskipamount}}
\newenvironment{example}[1][]{\ifx\namearg#1\namearg\exampleclaim\else\exampleclaimname{#1}\fi}{\endexampleclaim}

\newcounter{remark}[section]
\renewcommand{\theremark}{\thesection.\arabic{remark}}
\def\remarkclaim{\par\addvspace{\medskipamount}\noindent\refstepcounter{remark}\hbox{\bf
Remark
\thesection.\arabic{remark}:}\hspace{0.5em}\ignorespaces}
\def\remarkclaimname#1{\par\addvspace{\medskipamount}\noindent\refstepcounter{remark}\hbox{\bf
Remark
\thesection.\arabic{remark} {\rm (#1)}:}\hspace{0.5em}\ignorespaces}
\def\endremarkclaim{
\par\addvspace{\medskipamount}}
\newenvironment{remark}[1][]{\ifx\namearg#1\namearg\remarkclaim\else\remarkclaimname{#1}\fi}{\endremarkclaim}

\def\beginSolclaim{\par\addvspace{\medskipamount}\noindent\hbox{\bf Solution:}\hspace{0.5em}\ignorespaces}
\def\endSolclaim{\par\addvspace{-1em}\hfill\rule{1em}{0.4pt}\hspace{-0.4pt}\rule{0.4pt}{1em}\par\addvspace{\medskipamount}}
\newenvironment{exampleSol}[1][]{\beginSolclaim}{\endSolclaim}

% \addvspace{-1em}\hfill\rule{1em}{0.4pt}\hspace{-0.4pt}\rule{0.4pt}{1em}

% referencing
\makeatletter
    \DeclareRobustCommand{\myvref}[2]{%
      \leavevmode%
      \begingroup
        \let\T@pageref\@pagerefstar
        \hyperref[{#2}]{%
	  #1~\ref*{#2}%
        }%
        \vpageref[\unskip]{#2}%
      \endgroup
    }%

    \DeclareRobustCommand{\myref}[2]{%
      \leavevmode%
      \begingroup
        \let\T@pageref\@pagerefstar
        \hyperref[{#2}]{%
	  #1~\ref*{#2}%
        }%
      \endgroup
    }%
\makeatother

\newcommand{\figurevref}[1]{\myvref{Figure}{#1}}
\newcommand{\figureref}[1]{\myref{Figure}{#1}}
\newcommand{\tablevref}[1]{\myvref{Table}{#1}}
\newcommand{\tableref}[1]{\myref{Table}{#1}}
\newcommand{\chapterref}[1]{\myref{chapter}{#1}}
\newcommand{\Chapterref}[1]{\myref{Chapter}{#1}}
\newcommand{\appendixref}[1]{\myref{appendix}{#1}}
\newcommand{\Appendixref}[1]{\myref{Appendix}{#1}}
\newcommand{\sectionref}[1]{\myref{\S}{#1}}
\newcommand{\subsectionref}[1]{\myref{subsection}{#1}}
\newcommand{\subsectionvref}[1]{\myvref{subsection}{#1}}
\newcommand{\exercisevref}[1]{\myvref{Exercise}{#1}}
\newcommand{\exerciseref}[1]{\myref{Exercise}{#1}}
\newcommand{\examplevref}[1]{\myvref{Example}{#1}}
\newcommand{\exampleref}[1]{\myref{Example}{#1}}
\newcommand{\thmvref}[1]{\myvref{Theorem}{#1}}
\newcommand{\thmref}[1]{\myref{Theorem}{#1}}



% Here we input .pdf_t files
\newcommand{\inputpdft}[1]{\subimport*{figures/}{#1.pdf_t}}

%Fake contents lines
\newcommand{\addfakecontentsline}[1]{\addcontentsline{toc}{chapter}{#1}}

%Extra space in table of contents to make things fit
\newcommand{\addextraspacetotoc}{\addtocontents{toc}{\protect\enlargethispage{\baselineskip}}}

% graphics include
\newcommand{\diffyincludegraphics}[3]{\includegraphics[#1]{figures/#3}}
\newcommand{\myincludegraphics}[3]{\includegraphics[#1]{Images/#3}}

% only for pdf output
\newcommand{\diffypdfversion}[1]{#1}

% this draws a frame (implemented not as an environment as that for some
% reason does not play well with wrapfigure
\newcommand{\mybeginframe}{%
\begin{tcolorbox}[colback=white,colframe=lightgray,left=5pt,right=5pt]%
}
\newcommand{\myendframe}{%
\end{tcolorbox}%
}

\newcommand{\mybxbg}[1]{\tcboxmath[colback=white,colframe=black,boxrule=0.5pt,top=1.5pt,bottom=1.5pt]{#1}}
\newcommand{\mybxsm}[1]{\tcboxmath[colback=white,colframe=black,boxrule=0.5pt,left=0pt,right=0pt,top=0pt,bottom=0pt]{#1}}

% floaty inset figures

% this one should have a caption, first argument is the size
\newenvironment{mywrapfig}[2][]{
 \wrapfigure[#1]{r}{#2}
 \mybeginframe
 \centering
}{%
 \myendframe
 \endwrapfigure
}

% this one has no caption, first argument is size,
% the second argument is a larger size used for HTML (ignored by latex)
\newenvironment{mywrapfigsimp}[3][]{%
 \wrapfigure[#1]{r}{#2}%
 \centering%
}{%
 \endwrapfigure%
}

% this is just my figure style
\newenvironment{myfig}{%
\begin{figure}[h!t]
\mybeginframe%
\centering%
}{%
\myendframe
\end{figure}%
}

% Note that floating (inset) figures work badly in theorem like environments
% as those are implemented as lists.  That's why example and remark are
% reimplemented instead of using amsthm

% Do vbox.  It really forces things to be on the same page but it's
% really a last ditch thing as it will also add some extra spacing, it
% should definitely not be applied if not needed.
\newenvironment{mysamepage}{\vbox\bgroup}{\egroup}

%Do the Index
\newcommand{\diffyindex}{
 \cleardoublepage  
 \phantomsection
 \addfakecontentsline{\indexname}
 \printindex
}

%Do the TOC
\newcommand{\diffytableofcontents}{
\microtypesetup{protrusion=false}
\tableofcontents
\microtypesetup{protrusion=true}
}

% A title page
\newcommand{\myTitlePage}{
 \ifpdf
   \pdfbookmark{Title Page}{title}
 \fi
 \newlength{\centeroffset}
 \setlength{\centeroffset}{-0.5\oddsidemargin}
 \addtolength{\centeroffset}{0.5\evensidemargin}
 %\addtolength{\textwidth}{-\centeroffset}
 \thispagestyle{empty}
 \vspace*{\stretch{1.5}}
 \noindent\hspace*{\centeroffset}\makebox[0pt][l]{\begin{minipage}{\textwidth}
 \centering
 \begin{tcolorbox}[halign=center, sharp corners]
 {\Huge\bfseries \sffamily Differential Equations }
 \noindent\rule[-1ex]{\textwidth}{3pt}\\[2.5ex]
 \emph{\Large \sffamily An Introduction for Engineers}
 \end{tcolorbox}
 \end{minipage}}
 
 \vspace{\stretch{1}}
 \noindent\hspace*{\centeroffset}\makebox[0pt][l]{\begin{minipage}{\textwidth}
 \centering{\bfseries 
 by Matthew Charnley\\[3ex]} 
 \today
 \\
 (version \theversion)
 \end{minipage}}
 
 %\addtolength{\textwidth}{\centeroffset}
 \vspace{\stretch{2}}
}

\newcommand{\reviewSection}{\section*{Chapter Review}
\renewcommand{\thesection}{\thechapter.R}
\setcounter{subsection}{0}}

%%%%%%%%%%%%%%
% Reading Check Boxes

\newcounter{readC}[section]
\renewcommand{\thereadC}{\arabic{readC}}

\newsavebox{\rcanswers}

\newcommand{\rcAns}[1]{\setbox\rcanswers=\vbox{\unvbox\rcanswers\medskip\par\noindent\textbf{RC \thereadC:}\quad #1\par}}
\newcommand{\showrcAns}{
\subsection*{Reading Check Answers}
 \unvbox\rcanswers\setbox\rcanswers=\vbox{}\vspace{\baselineskip}
}

\newcommand{\RC}[2]{\refstepcounter{readC}\begin{tcolorbox}[title=\textbf{Reading Check \thereadC}, colback=rutgersred!10!white, colframe=rutgersred!100!white, colbacktitle=rutgersred!100!white, coltitle=black, toptitle=1mm] #1 \end{tcolorbox} \rcAns{#2}}

\newcommand{\TODO}[1]{\begin{tcolorbox}[title=\textbf{TODO}, colback = yellow!20!white, colframe=orange!80!white, coltitle=black, boxrule=2mm] #1 \end{tcolorbox}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Boxes for MATLAB code

\tcbuselibrary{listings}
\tcbuselibrary{minted}

\usepackage{minted}

\newtcblisting[]{matlab}{listing engine=minted, minted language=matlab, listing only}

\newcommand{\LAtt}[1]{\noindent \emph{Attribution: \cite{JL}, \S #1.} \medskip \par}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Other commands

\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Definitions

\newtcolorbox[auto counter,number within=section]{definition}[1][]{colback=red!5!white,colframe=red!75!black, fonttitle=\bfseries, title=Definition~\thetcbcounter, label=#1}

\newtcolorbox[auto counter,number within=section]{theorem}[1][]{colback=blue!5!white,colframe=blue!75!black, title={\bfseries Theorem~\thetcbcounter}\ \ifx\namearg#1\namearg \else (#1)\fi}

\newtcolorbox[auto counter,number within=section]{theorem1}[2][]{colback=blue!5!white,colframe=blue!75!black, label=#1, title={\bfseries Theorem~\thetcbcounter}\ \ifx\namearg#2\namearg \else (#2)\fi}

\newtcolorbox{LOBox}[1][]{colback=green!15!white,colframe=green!45!white, title={\bfseries Learning Objectives}, coltitle=black}

\newcommand{\LO}[1]{\begin{LOBox}
After this section, you will be able to:
\begin{itemize} \itemsep -0.3em
#1
\end{itemize}
\end{LOBox} }

% \newtcolorbox[auto counter,number within=section]{example}[1][]{%
% colback=blue!5!white,colframe=blue!75!black, fonttitle=\bfseries,
% title=Example~\thetcbcounter #1}

% \newenvironment{exampleSol}{\noindent\textbf{Solution:}}{\unskip\hfill\rule{1em}{0.4pt}\hspace{-0.4pt}\rule{0.4pt}{1em}\smallskip}